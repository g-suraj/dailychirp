---
import Header from "../components/Header.astro";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>Daily Chirp</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />

    <style is:global>
      .styled-link {
        text-decoration: underline;
      }
      .button[disabled] {
        opacity: 1;
      }

      .image-container,
      .credits-details-container,
      .audio-container,
      .result {
        padding: 0;
      }

      .credits-details-container {
        font-size: 10px;
      }

      .audio-container,
      .result {
        margin-top: 5px;
      }

      .result {
        padding: 0 10px;
      }

      .bird-image {
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
      }

      @media (min-width: 900px) {
        .bird-image {
          width: 500px;
        }

        .bird-audio {
          width: 500px;
        }

        .buttons-container {
          width: 50%;
          margin: 0 auto;
        }

        .button-div {
          padding: 5px;
        }
        .audiowrapper {
          height: inherit;
          width: 30%;
          margin: 0 auto;
        }
      }

      @media (min-width: 300px) and (max-width: 900px) {
        .bird-audio,
        .guess-button,
        .buttons-container {
          width: 100%;
        }

        .bird-image {
          width: 100%;
        }

        .button-div {
          width: 50%;
          float: left;
          padding: 0 5px;
        }
        .audiowrapper {
          height: inherit;
          width: 100%;
          margin: 0 auto;
        }
      }

      .play,
      .refresh {
        height: inherit;
        width: 50%;
        float: left;
      }

      .audio-container {
        height: 8vh;
      }
    </style></head
  >

  <Header />

  <script>
    import type { Bird } from "../types/types";

    const today = new Date().toDateString();
    const result = document.querySelector(".result");
    const image = document.querySelector(".bird-image");

    const playButton = document.querySelector(".play");
    const refreshButton = document.querySelector(".refresh");

    const buttonsContainer = document.querySelector(".buttons-container");
    const creditsDetailsContainer = document.querySelector(
      ".credits-details-container",
    );

    async function stableStringToNumGenerator(
      str: string,
      modulo: number,
    ): Promise<number> {
      /* Generate stable random numbers which are index into the birds object */
      const msgUint8 = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.reduce((prev, curr) => prev * curr) % modulo;
    }

    /* Helper to generate today's guesses in a stable manner */
    async function todaysGuesses(todayDateStr: string, numBirds: number) {
      const todaysIndex = await stableStringToNumGenerator(
        todayDateStr,
        numBirds,
      );
      console.log(todaysIndex);
      let guesses: number[] = [];
      for (let i = 0; i < 3; ++i) {
        guesses.push((todaysIndex + i + 1) % numBirds);
      }
      const insertionIndex = Math.floor(Math.random() * 4);
      guesses.splice(insertionIndex, 0, todaysIndex);
      return { todaysIndex, guesses };
    }

    window.addEventListener("load", async () => {
      const data = await fetch(
        "https://g-suraj.github.io/xeno-canto-processed/pickled_data.json",
      );
      let audio: HTMLAudioElement | null = null;
      const birds: Bird[] = await data.json();
      const numBirds = birds.length;

      const todayDateStr = new Date().toDateString();
      const { todaysIndex, guesses } = await todaysGuesses(
        todayDateStr,
        numBirds,
      );

      const todaysBird = birds[todaysIndex];
      const pictureIndex = guesses[1] % todaysBird["_pictures"].length;
      const todaysPicture = todaysBird["_pictures"][pictureIndex];
      let occurenceIndex = guesses[0] % todaysBird["_occurrences"].length;
      let todaysOccurence = todaysBird["_occurrences"][occurenceIndex];

      if (creditsDetailsContainer) {
        creditsDetailsContainer.innerHTML = `Audio recording is courtesy of ${todaysOccurence["__rightsHolder"]}.`;
      }

      image?.setAttribute("src", todaysPicture);
      image?.removeAttribute("hidden");

      refreshButton?.addEventListener("click", () => {
        audio?.pause();
        occurenceIndex = Math.floor(
          Math.random() * todaysBird["_occurrences"].length,
        );
        todaysOccurence = todaysBird["_occurrences"][occurenceIndex];
        audio = new Audio(todaysOccurence["__birdsong"]);
        audio?.play();
        if (creditsDetailsContainer) {
          creditsDetailsContainer.innerHTML = `Audio recording is courtesy of ${todaysOccurence["__rightsHolder"]}.`;
        }
      });

      playButton?.addEventListener("click", () => {
        audio = new Audio(todaysOccurence["__birdsong"]);
        audio.play();
      });

      const hasGuessed = today in localStorage;

      guesses.forEach((guess: number) => {
        let btn = document.createElement("div");
        btn.className = "button-div";
        btn.innerHTML += `
          <button 
              class="button guess-button"
              value="${guess === todaysIndex ? "yes" : "no"}|${guess}">${birds[guess]["vernacularName"]}
          </button>
        `;
        btn.addEventListener("click", () => {
          localStorage.setItem(today, `${guess}`);
          refreshState();
          image?.setAttribute("style", "");
        });
        buttonsContainer?.appendChild(btn);
      });

      if (hasGuessed) {
        refreshState();
      }
      image?.setAttribute("style", hasGuessed ? "" : "filter: blur(15px)");

      function refreshState() {
        const userGuess = localStorage.getItem(today) || "";
        const buttons = document.querySelectorAll(".guess-button");
        let userCorrectGuess = true;
        buttons?.forEach((button) => {
          if (button.getAttribute("value")?.startsWith("yes")) {
            button.classList.add("is-success");
          }

          if (button.getAttribute("value") === `no|${userGuess}`) {
            button.classList.add("is-danger");
            userCorrectGuess = false;
          }
          button.setAttribute("disabled", "");
        });

        if (result) {
          if (userCorrectGuess) {
            result.innerHTML += "<b>That's right</b>!";
          } else {
            result.innerHTML += "<b>Tough luck!</b>";
          }
          result.innerHTML += `<br>What you hear is a "${birds[todaysIndex]["vernacularName"]}"<br>(<i>${birds[todaysIndex]["scientificName"]}</i>)`;
          result.innerHTML += `<br><br><a class='styled-link' href='https://www.gbif.org/species/${todaysOccurence["speciesKey"]}'>Click here</a> for more about this bird.`;
        }
      }
    });
  </script>

  <body>
    <div class="loaded">
      <div class="columns is-centered is-multiline is-mobile">
        <div class="column is-full has-text-centered">
          <div class="title is-4" style="margin-top: 10px;">
            Guess the Birdsong ðŸŽ¶
          </div>
        </div>

        <div class="column is-full has-text-centered image-container">
          <img class="bird-image" alt="A bird." hidden />
        </div>

        <div class="column is-full has-text-centered credits-details-container">
        </div>
        <div class="column is-full has-text-centered audio-container">
          <div class="audiowrapper">
            <div class="play">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="100%"
                height="100%"
                viewBox="0 0 24 24"
                ><path fill="currentColor" d="M8 5.14v14l11-7z"></path></svg
              >
            </div>
            <div class="refresh">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="100%"
                height="100%"
                ><path
                  fill="currentColor"
                  d="M12 20q-3.35 0-5.675-2.325T4 12q0-3.35 2.325-5.675T12 4q1.725 0 3.3.712T18 6.75V4h2v7h-7V9h4.2q-.8-1.4-2.187-2.2T12 6Q9.5 6 7.75 7.75T6 12q0 2.5 1.75 4.25T12 18q1.925 0 3.475-1.1T17.65 14h2.1q-.7 2.65-2.85 4.325T12 20"
                ></path></svg
              >
            </div>
          </div>
        </div>

        <div class="column has-text-centered">
          <div class="is-centered buttons buttons-container"></div>
        </div>
        <div class="column is-full has-text-centered result"></div>
      </div>
    </div>
  </body>
</html>
